
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>Mano Snippets | PHP - Angular Security</title>

    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">

    <!-- Favicons -->
<meta name="theme-color" content="#7952b3">


    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="assets/style.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/snippets/atom-one-dark.min.css">
  </head>
  <body>
    
<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
  <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Mano Snippets</a>
  <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <input class="form-control form-control-dark w-100" type="text" placeholder="Search" aria-label="Search">
  <div class="navbar-nav">
    <div class="nav-item text-nowrap"></div>
  </div>
</header>

<div class="container-fluid">
  <div class="row">
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="/pvz">
              <span data-feather="home"></span>
              Home
            </a>
          </li>
          
          <li class="nav-item">
            <a class="nav-link" href="PHP_SQL_PDO.html">
              <span data-feather="file"></span>
              PHP - SQL (PDO)
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link active" href="PHP_Angular_Security.html">
              <span data-feather="file"></span>
              PHP Angular - Security
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="SQL.html">
              <span data-feather="file"></span>
              SQL Commands
            </a>
          </li>
          
        </ul>

        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>Additional Links</span>
        </h6>
        <ul class="nav flex-column mb-2">
          
          <li class="nav-item">
            <a class="nav-link" href="https://www.freewebtoolkit.com/html-encode" target="_blank">
              <span data-feather="file-text"></span>
              HTML Encoder
            </a>
          </li>

        </ul>
      </div>
    </nav>

    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 pt-3">
      

      <h2>PHP - Angular Security</h2>
        
        <div class="col-12 pt-1 pb-5">










          <!-- ROW Start -->
          <div class="row pt-3">

              <div class="col-lg-6">
                  <div class="card shadow">
                      <div class="card-header">
                        <h4 style="color:rgb(44 144 229);">PHP</h4>
                        <small class="text-muted">
                          <h6>PHP Start Cookie</h6>
                            When loging in a user, PHP will need to create a Cookie with the name "XSRF-TOKEN".
                            This cookie will be automatically recognised by Angularjs and will be sent each time tith Http request as heather "HTTP_X_XSRF_TOKEN"<br>
                            PHP generate XSRF Token function.<br>
                            Can be added all in to one Functions.php file.
                        </small>
                      </div>
                      <div class="card-body py-0">
                          
                          <pre class="m-0">
                              <code style="border-radius: 0.375rem;">
function generate_XSRF_token($UserName) {

  $cookie_name = "XSRF-TOKEN";
  $method = 'aes128';
  $pass = hash('sha256', uniqid(mt_rand(), true));
  $cookie_value = preg_replace("/[^A-Za-z0-9.!?]/",'',openssl_encrypt ($UserName, $method, $pass));
  setcookie($cookie_name, $cookie_value, time() + (86400 * 30), "/"); // 86400 = 1 day

}
                              </code>
                            </pre>

                      </div>
                    </div>
              </div>
              
              <div class="col-lg-6">
                <div class="card shadow">
                    <div class="card-header">
                      <h4 style="color:rgb(44 144 229);">PHP</h4>
                      <small class="text-muted">
                        <h6>PHP Create CSRF Token</h6>
                        PHP generate CSRF Token function<br>
                        Can be added all in to one Functions.php file.
                      </small>
                    </div>
                    <div class="card-body py-0">
                        
                        <pre class="m-0">
                            <code style="border-radius: 0.375rem;">
function createToken() {
  $seed = urlSafeEncode(random_bytes(8));
  $secret = '54sdfasfGSAdd54121vds';
  $t = time();
  $hash = urlSafeEncode(hash_hmac('sha256', session_id() . $seed . $t, $secret, true));
  return urlSafeEncode($hash . '|' . $seed . '|' . $t);
}

function urlSafeEncode($m) {
  return rtrim(strtr(base64_encode($m), '+/', '-_'), '=');
}
                            </code>
                          </pre>

                    </div>
                  </div>
            </div>
          
          </div>
          <!-- ROW End -->



          <!-- ROW Start -->
          <div class="row pt-3">

            <div class="col-lg-6">
              <div class="card shadow">
                <div class="card-header">
                  <h4 style="color:rgb(44 144 229);">PHP</h4>
                  <small class="text-muted">
                    <h6>PHP Validate CSRF Token</h6>
                    PHP validate CSRF Token function<br>
                    Can be added all in to one Functions.php file.
                  </small>
                </div>
                <div class="card-body py-0">
                    
                  <pre class="m-0">
                    <code style="border-radius: 0.375rem;">
function validateToken($token) {
  $parts = explode('|', urlSafeDecode($token));
  $secret = '54sdfasfGSAdd54121vds';
  if(count($parts) === 3) {
      $hash = hash_hmac('sha256', session_id() . $parts[1] . $parts[2], $secret, true);
      if(hash_equals($hash, urlSafeDecode($parts[0]))) {
          return true;
      }
  }
  return false;
}

function urlSafeDecode($m) {
  return base64_decode(strtr($m, '-_', '+/'));
}
                    </code>
                  </pre>

                </div>
              </div>
            </div>
            
            <div class="col-lg-6">
              <div class="card shadow">
                <div class="card-header">
                  <h4 style="color:rgb(44 144 229);">PHP</h4>
                  <small class="text-muted">
                    <h6>PHP Token Validation</h6>
                    PHP validate XSRF Token function and sending CSRF token<br>
                    Can be added all in to one Functions.php file.
                  </small>
                </div>
                <div class="card-body py-0">
                    
                  <pre class="m-0">
                    <code style="border-radius: 0.375rem;">
function compare_XSRF_token_received_CSRF_Token_Send($server_T, $cookie_T){

  if($server_T === $cookie_T){
      return createToken();
  }else{
      return false;
      header("Location: ../login");
      exit();
  }
}
                    </code>
                  </pre>

                </div>
              </div>
            </div>
        
          </div>
          <!-- ROW End -->



        <!-- ROW Start -->
        <div class="row pt-3">

          <div class="col-lg-6">
            <div class="card shadow">
              <div class="card-header">
                <h4 style="color:rgb(44 144 229);">PHP</h4>
                <small class="text-muted">
                  <h6>PHP Is User LogedIn</h6>
                  PHP check if user loged in and its session "auth" is existing<br>
                  Can be added all in to one Functions.php file.
                </small>
              </div>
              <div class="card-body py-0">
                  
                <pre class="m-0">
                  <code style="border-radius: 0.375rem;">
function check_logged_in() {
  if (isset($_SESSION['auth'])){ 
      return true; 
  }else {
      header("Location: ../login");
      exit();
  }
}
                  </code>
                </pre>

              </div>
            </div>
          </div>
          
          <div class="col-lg-6">
            <div class="card shadow">
              <div class="card-header">
                <h4 style="color:rgb(44 144 229);">PHP</h4>
                <small class="text-muted">
                  <h6>PHP Tokents file sample</h6>
                  Get CSRF token PHP file can look like this.<br>
                  Includes/CSRF.php
                </small>
              </div>
              <div class="card-body py-0">
                  
                <pre class="m-0">
                  <code style="border-radius: 0.375rem;">
if ($_SERVER["REQUEST_METHOD"] == "POST") {
  echo json_encode(compare_XSRF_token_received_CSRF_Token_Send($_SERVER["HTTP_X_XSRF_TOKEN"], $_COOKIE["XSRF-TOKEN"]));
  exit;
}else{

  return false;
  header("Location: ../login");
  exit();
}
                  </code>
                </pre>

              </div>
            </div>
          </div>
      
        </div>
        <!-- ROW End -->


        <!-- ROW Start -->
        <div class="row pt-3">

          <div class="col-lg-6">
            <div class="card shadow">
              <div class="card-header">
                <h4 style="color:rgb(44 144 229);">PHP</h4>
                <small class="text-muted">
                  <h6>PHP All Validations and processing</h6>
                  Main PHP get details file where to process and provide all the data, all the validations must be checked.<br>
                  Normal_call.php
                </small>
              </div>
              <div class="card-body py-0">
                  
                <pre class="m-0">
                  <code style="border-radius: 0.375rem;">
session_start();

if(check_logged_in()){
  if(compare_XSRF_token_received($_SERVER["HTTP_X_XSRF_TOKEN"], $_COOKIE["XSRF-TOKEN"])){

    $data = json_decode(file_get_contents("php://input"));
    $content = json_decode(file_get_contents("php://input"));
    $request_type = $data->request_type;

    if(validateToken($data->request_type)){

    // ============  CONTENT TO PROCESS  ============ //
      $content = array( "Some Details"=>"Bilekiek informacijos" );
  
      $data = array( "Status"=>0, "Message"=>"Success", "Content"=>$content );
      echo json_encode($data);
      exit;
    // ============  CONTENT TO PROCESS  ============ //
  
    }else{
      $data = array( "Status"=>1, "Message"=>"Action not authorised. CSRF Token ERROR", "Content"=>"" );
      echo json_encode($data);
      exit;
    }
  }else{
    $data = array( "Status"=>1, "Message"=>"Action not Authorised - XSRF Token ERROR!", "Content"=>"" );
    echo json_encode($data);
    exit;
  }
}else{
    $data = array( "Status"=>1, "Message"=>"You are not Authorised to access this content!", "Content"=>"" );
    echo json_encode($data);
    exit;
}
                  </code>
                </pre>

              </div>
            </div>
          </div>
          
          <div class="col-lg-6">
            <div class="card shadow">
              <div class="card-header">
                <h4 style="color:rgb(152, 0, 86);">Angular</h4>
                <small class="text-muted">
                  <h6>Angular HTTP CSRF request</h6>
                  This is the basic HTTP request of Angular, where the first HTTP requests is checking "../includes/CSRP.php" file to confirm XSRF token and receive CSRF generated token.<br>
If this request is successful, the next HTTP request will be made to the actual POST request. This request, thesame as the previouse one, will send the XSRF token in the header and received CRSF token in the body as "request_type".<br>
Next, all the data will be checked in the PHP file.
                </small>
              </div>
              <div class="card-body py-0">
                  
                <pre class="m-0">
                  <code style="border-radius: 0.375rem;">
$scope.get_Normal_Data = function(){

  $http({
    method: 'post',
    url: '../includes/CSRF.php'
  }).then(function successCallback(response) {
    var tokenas_CSRF = response.data;

    $http({
      method: 'post',
      url: 'includes/normal_call.php',
      data: {request_type:tokenas_CSRF},
    }).then(function successCallback(response) {
        
      if(response.data.Status === 0){
        console.log("All OK");
        console.log(response.data);
      }else{
        console.log("Error");
        console.log(response.data);
      }

    });

  });

}
                  </code>
                </pre>

              </div>
            </div>
          </div>
      
        </div>
        <!-- ROW End -->








        </div>



    </main>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
<script src="assets/script.js"></script>
<script src="assets/snippets/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

  </body>
</html>
